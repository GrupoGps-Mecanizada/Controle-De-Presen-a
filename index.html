<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Controle de Presença</title>
    <meta name="theme-color" content="#1F4E78">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Animações */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Status buttons */
        .status-btn { transition: all 0.2s; }
        .status-btn.active { transform: scale(1.05); }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app"></div>

    <script>
        // ============================================
        // CONFIGURAÇÃO
        // ============================================
        const GOOGLE_SCRIPT_URL = 'SUA_URL_DO_GOOGLE_APPS_SCRIPT_AQUI';
        
        // ============================================
        // CÓDIGOS DE STATUS
        // ============================================
        const STATUS_CODES = {
            'P': { label: 'Presente', color: 'green', icon: 'check-circle' },
            'F': { label: 'Falta', color: 'red', icon: 'x-circle' },
            'FE': { label: 'Férias', color: 'yellow', icon: 'sun' },
            'TR': { label: 'Treinamento', color: 'blue', icon: 'student' },
            'AF': { label: 'Afastado', color: 'gray', icon: 'warning' },
            'AT': { label: 'Atestado', color: 'orange', icon: 'first-aid' },
            'FO': { label: 'Folga', color: 'purple', icon: 'coffee' },
            'EX': { label: 'Extra', color: 'teal', icon: 'star' }
        };

        // ============================================
        // ESTADO DA APLICAÇÃO
        // ============================================
        let state = {
            view: 'login',
            supervisor: null,
            employees: [],
            selectedDate: getCurrentDate(),
            attendanceRecords: {},
            isLoading: false,
            statistics: null
        };

        // ============================================
        // UTILITÁRIOS
        // ============================================
        function getCurrentDate() {
            return new Date().toISOString().split('T')[0];
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('pt-BR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function getColorClass(color, type = 'bg') {
            const colors = {
                green: type === 'bg' ? 'bg-green-100 border-green-500 text-green-800' : 'bg-green-600',
                red: type === 'bg' ? 'bg-red-100 border-red-500 text-red-800' : 'bg-red-600',
                yellow: type === 'bg' ? 'bg-yellow-100 border-yellow-500 text-yellow-800' : 'bg-yellow-600',
                blue: type === 'bg' ? 'bg-blue-100 border-blue-500 text-blue-800' : 'bg-blue-600',
                gray: type === 'bg' ? 'bg-gray-100 border-gray-500 text-gray-800' : 'bg-gray-600',
                orange: type === 'bg' ? 'bg-orange-100 border-orange-500 text-orange-800' : 'bg-orange-600',
                purple: type === 'bg' ? 'bg-purple-100 border-purple-500 text-purple-800' : 'bg-purple-600',
                teal: type === 'bg' ? 'bg-teal-100 border-teal-500 text-teal-800' : 'bg-teal-600'
            };
            return colors[color] || colors.gray;
        }

        // ============================================
        // SERVIÇOS / API
        // ============================================
        async function login(username, password) {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro no login:', error);
                return { success: false, error: error.message };
            }
        }

        async function getEmployees(supervisor) {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getEmployees&supervisor=${encodeURIComponent(supervisor)}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro ao buscar colaboradores:', error);
                return { success: false, error: error.message };
            }
        }

        async function getTodayAttendance(supervisor, date) {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAttendance&supervisor=${encodeURIComponent(supervisor)}&date=${date}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro ao buscar presença:', error);
                return { success: false, error: error.message };
            }
        }

        async function saveAttendance(record) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'saveAttendance', ...record })
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro ao salvar presença:', error);
                return { success: false, error: error.message };
            }
        }

        async function saveMultipleAttendance(records) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'saveMultipleAttendance', records: records })
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro ao salvar presenças:', error);
                return { success: false, error: error.message };
            }
        }

        async function getStatistics(supervisor, startDate, endDate) {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getStatistics&supervisor=${encodeURIComponent(supervisor)}&startDate=${startDate}&endDate=${endDate}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro ao buscar estatísticas:', error);
                return { success: false, error: error.message };
            }
        }

        // ============================================
        // LÓGICA DE NEGÓCIO
        // ============================================
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('Preencha todos os campos');
                return;
            }

            state.isLoading = true;
            render();

            const result = await login(username, password);

            if (result.success) {
                state.supervisor = result.supervisor;
                localStorage.setItem('supervisor', JSON.stringify(result.supervisor));
                await loadEmployees();
                await loadTodayAttendance();
                state.view = 'attendance';
            } else {
                alert('Login falhou: ' + (result.error || 'Credenciais inválidas'));
            }

            state.isLoading = false;
            render();
        }

        async function loadEmployees() {
            const result = await getEmployees(state.supervisor.nome);
            if (result.success) {
                state.employees = result.employees;
            }
        }

        async function loadTodayAttendance() {
            const result = await getTodayAttendance(state.supervisor.nome, state.selectedDate);
            if (result.success) {
                state.attendanceRecords = {};
                result.records.forEach(record => {
                    state.attendanceRecords[record.employeeId] = record.status;
                });
            }
        }

        function setAttendance(employeeId, status) {
            state.attendanceRecords[employeeId] = status;
            render();
        }

        async function saveAllAttendance() {
            const records = [];
            
            for (const employeeId in state.attendanceRecords) {
                const employee = state.employees.find(e => e.id === employeeId);
                if (employee) {
                    records.push({
                        date: state.selectedDate,
                        employeeId: employee.id,
                        employeeName: employee.nome,
                        function: employee.funcao,
                        regime: employee.regime,
                        supervisor: state.supervisor.nome,
                        status: state.attendanceRecords[employeeId],
                        observations: ''
                    });
                }
            }

            if (records.length === 0) {
                alert('Nenhuma presença registrada');
                return;
            }

            state.isLoading = true;
            render();

            const result = await saveMultipleAttendance(records);

            if (result.success) {
                alert(`✅ ${records.length} registros salvos com sucesso!`);
            } else {
                alert('Erro ao salvar: ' + result.error);
            }

            state.isLoading = false;
            render();
        }

        function handleLogout() {
            localStorage.removeItem('supervisor');
            state.supervisor = null;
            state.employees = [];
            state.attendanceRecords = {};
            state.view = 'login';
            render();
        }

        async function changeDate(newDate) {
            state.selectedDate = newDate;
            await loadTodayAttendance();
            render();
        }

        async function loadStatisticsView() {
            state.view = 'statistics';
            state.isLoading = true;
            render();

            // Pega estatísticas do mês atual
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

            const result = await getStatistics(state.supervisor.nome, startDate, endDate);
            
            if (result.success) {
                state.statistics = result.statistics;
            }

            state.isLoading = false;
            render();
        }

        // ============================================
        // RENDERIZAÇÃO
        // ============================================
        function render() {
            const app = document.getElementById('app');
            
            switch(state.view) {
                case 'login':
                    app.innerHTML = renderLogin();
                    break;
                case 'attendance':
                    app.innerHTML = renderAttendance();
                    break;
                case 'statistics':
                    app.innerHTML = renderStatistics();
                    break;
            }
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex flex-col justify-center items-center p-6 bg-gradient-to-br from-blue-900 to-blue-700">
                    <div class="bg-white p-8 rounded-2xl w-full max-w-sm shadow-2xl fade-in">
                        <div class="flex justify-center mb-6 text-blue-900">
                            <i class="ph-fill ph-identification-card text-7xl"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Controle de Presença</h1>
                        <p class="text-center text-gray-500 mb-8 text-sm">Sistema de Marcação Diária</p>
                        
                        <form onsubmit="handleLogin(event)" class="space-y-6">
                            <div>
                                <label class="text-sm font-bold text-gray-700 block mb-2 uppercase">Supervisor</label>
                                <input 
                                    type="text" 
                                    id="username"
                                    class="w-full border-2 border-gray-300 rounded-lg p-4 focus:border-blue-600 outline-none text-lg"
                                    placeholder="Digite seu nome"
                                    ${state.isLoading ? 'disabled' : ''}
                                    required
                                >
                            </div>
                            
                            <div>
                                <label class="text-sm font-bold text-gray-700 block mb-2 uppercase">Senha</label>
                                <input 
                                    type="password" 
                                    id="password"
                                    class="w-full border-2 border-gray-300 rounded-lg p-4 focus:border-blue-600 outline-none text-lg"
                                    placeholder="Digite sua senha"
                                    ${state.isLoading ? 'disabled' : ''}
                                    required
                                >
                            </div>
                            
                            <button 
                                type="submit" 
                                class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2"
                                ${state.isLoading ? 'disabled' : ''}
                            >
                                ${state.isLoading ? '<i class="ph ph-spinner animate-spin text-2xl"></i> ENTRANDO...' : '<i class="ph ph-sign-in text-xl"></i> ENTRAR'}
                            </button>
                        </form>
                        
                        <div class="mt-6 text-center text-xs text-gray-400">
                            <p>Versão 1.0 | © 2026</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAttendance() {
            const totalMarked = Object.keys(state.attendanceRecords).length;
            const totalEmployees = state.employees.length;
            const progress = totalEmployees > 0 ? Math.round((totalMarked / totalEmployees) * 100) : 0;

            return `
                <div class="min-h-screen bg-gray-50 pb-24">
                    <!-- Header -->
                    <header class="bg-gradient-to-r from-blue-900 to-blue-700 text-white p-4 sticky top-0 z-30 shadow-lg">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <h1 class="font-bold text-xl">Marcação de Presença</h1>
                                <p class="text-sm opacity-90">${state.supervisor.nome}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="loadStatisticsView()" class="p-2 rounded-full hover:bg-white/20 transition-all">
                                    <i class="ph ph-chart-bar text-2xl"></i>
                                </button>
                                <button onclick="handleLogout()" class="p-2 rounded-full hover:bg-white/20 transition-all">
                                    <i class="ph ph-sign-out text-2xl"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Data Selector -->
                        <div class="bg-white/10 rounded-lg p-3 backdrop-blur-sm">
                            <div class="flex items-center justify-between">
                                <button onclick="changeDate('${getPreviousDay(state.selectedDate)}')" class="p-2 hover:bg-white/20 rounded-lg">
                                    <i class="ph ph-caret-left text-xl"></i>
                                </button>
                                <div class="flex-1 text-center">
                                    <input 
                                        type="date" 
                                        value="${state.selectedDate}"
                                        onchange="changeDate(this.value)"
                                        class="bg-transparent text-white text-center font-bold outline-none cursor-pointer"
                                    >
                                    <p class="text-xs opacity-75 mt-1">${formatDate(state.selectedDate)}</p>
                                </div>
                                <button onclick="changeDate('${getNextDay(state.selectedDate)}')" class="p-2 hover:bg-white/20 rounded-lg">
                                    <i class="ph ph-caret-right text-xl"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="mt-3">
                            <div class="flex justify-between text-xs mb-1">
                                <span>Progresso: ${totalMarked}/${totalEmployees}</span>
                                <span>${progress}%</span>
                            </div>
                            <div class="w-full bg-white/20 rounded-full h-2">
                                <div class="bg-green-400 h-2 rounded-full transition-all" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </header>

                    <!-- Employees List -->
                    <main class="p-4 space-y-3 max-w-2xl mx-auto">
                        ${state.employees.length === 0 ? renderNoEmployees() : ''}
                        ${state.employees.map(emp => renderEmployeeCard(emp)).join('')}
                    </main>

                    <!-- Fixed Bottom Bar -->
                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-gray-200 p-4 shadow-lg">
                        <button 
                            onclick="saveAllAttendance()"
                            ${state.isLoading || totalMarked === 0 ? 'disabled' : ''}
                            class="w-full max-w-2xl mx-auto block bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed hover:bg-green-700 transition-all flex items-center justify-center gap-2"
                        >
                            ${state.isLoading ? '<i class="ph ph-spinner animate-spin text-2xl"></i> SALVANDO...' : `<i class="ph ph-floppy-disk text-2xl"></i> SALVAR ${totalMarked} REGISTROS`}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderNoEmployees() {
            return `
                <div class="text-center py-12 bg-white rounded-xl shadow-sm">
                    <i class="ph ph-users-three text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Nenhum colaborador encontrado</p>
                </div>
            `;
        }

        function renderEmployeeCard(employee) {
            const currentStatus = state.attendanceRecords[employee.id];
            
            return `
                <div class="bg-white rounded-xl shadow-md overflow-hidden border-2 ${currentStatus ? 'border-green-500' : 'border-gray-200'} fade-in">
                    <div class="p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-gray-800 leading-tight">${employee.nome}</h3>
                                <div class="flex gap-2 mt-1 flex-wrap">
                                    <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full font-semibold">${employee.funcao}</span>
                                    <span class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded-full font-semibold">${employee.regime}</span>
                                </div>
                            </div>
                            ${currentStatus ? `
                                <div class="text-right">
                                    <div class="w-10 h-10 rounded-full ${getColorClass(STATUS_CODES[currentStatus].color, 'full')} flex items-center justify-center">
                                        <i class="ph-fill ph-${STATUS_CODES[currentStatus].icon} text-white text-xl"></i>
                                    </div>
                                    <p class="text-xs font-bold mt-1">${currentStatus}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Status Options Grid -->
                        <div class="grid grid-cols-4 gap-2">
                            ${Object.entries(STATUS_CODES).map(([code, info]) => `
                                <button 
                                    onclick="setAttendance('${employee.id}', '${code}')"
                                    class="status-btn p-3 rounded-lg border-2 transition-all ${
                                        currentStatus === code 
                                            ? getColorClass(info.color) + ' scale-105 shadow-md active' 
                                            : 'border-gray-200 hover:border-gray-300 bg-white'
                                    }"
                                >
                                    <i class="ph-fill ph-${info.icon} text-2xl ${currentStatus === code ? '' : 'text-gray-400'}"></i>
                                    <p class="text-xs font-bold mt-1 ${currentStatus === code ? '' : 'text-gray-500'}">${code}</p>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStatistics() {
            if (!state.statistics) {
                return `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center">
                        <i class="ph ph-spinner animate-spin text-6xl text-blue-600"></i>
                    </div>
                `;
            }

            const total = Object.values(state.statistics).reduce((a, b) => a + b, 0);

            return `
                <div class="min-h-screen bg-gray-50 pb-6">
                    <!-- Header -->
                    <header class="bg-gradient-to-r from-blue-900 to-blue-700 text-white p-4 sticky top-0 z-30 shadow-lg">
                        <div class="flex items-center gap-4">
                            <button onclick="state.view='attendance'; render()" class="p-2 rounded-full hover:bg-white/20">
                                <i class="ph ph-arrow-left text-2xl"></i>
                            </button>
                            <div>
                                <h1 class="font-bold text-xl">Estatísticas</h1>
                                <p class="text-sm opacity-90">Resumo do Mês</p>
                            </div>
                        </div>
                    </header>

                    <!-- Statistics Cards -->
                    <main class="p-4 max-w-2xl mx-auto space-y-4">
                        <div class="bg-white rounded-xl shadow-md p-6 text-center border-2 border-blue-200">
                            <i class="ph ph-calendar-check text-5xl text-blue-600 mb-2"></i>
                            <h2 class="text-4xl font-black text-gray-800">${total}</h2>
                            <p class="text-sm text-gray-500 font-semibold uppercase tracking-wide">Total de Registros</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            ${Object.entries(STATUS_CODES).map(([code, info]) => `
                                <div class="bg-white rounded-xl shadow-md p-5 text-center border-2 ${state.statistics[code] > 0 ? 'border-' + info.color + '-300' : 'border-gray-200'}">
                                    <div class="w-12 h-12 rounded-full ${getColorClass(info.color, 'full')} flex items-center justify-center mx-auto mb-2">
                                        <i class="ph-fill ph-${info.icon} text-white text-2xl"></i>
                                    </div>
                                    <h3 class="text-3xl font-black text-gray-800">${state.statistics[code] || 0}</h3>
                                    <p class="text-xs font-bold uppercase tracking-wider text-gray-600 mt-1">${info.label}</p>
                                    <p class="text-xs text-gray-400 mt-1">${code}</p>
                                </div>
                            `).join('')}
                        </div>
                    </main>
                </div>
            `;
        }

        // Funções auxiliares de data
        function getPreviousDay(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            date.setDate(date.getDate() - 1);
            return date.toISOString().split('T')[0];
        }

        function getNextDay(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            date.setDate(date.getDate() + 1);
            return date.toISOString().split('T')[0];
        }

        // ============================================
        // INICIALIZAÇÃO
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            const savedSupervisor = localStorage.getItem('supervisor');
            if (savedSupervisor) {
                state.supervisor = JSON.parse(savedSupervisor);
                loadEmployees().then(() => {
                    loadTodayAttendance().then(() => {
                        state.view = 'attendance';
                        render();
                    });
                });
            } else {
                render();
            }
        });
    </script>
</body>
</html>

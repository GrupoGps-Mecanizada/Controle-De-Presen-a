<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Controle de Presença - Sistema Completo</title>
    <meta name="theme-color" content="#1F4E78">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * { font-family: 'Poppins', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Animações */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-in { animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        
        /* Status buttons */
        .status-btn { transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        .status-btn.active { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .status-btn:hover:not(.active) { transform: translateY(-2px); }
        
        /* Dashboard Grid */
        .dashboard-grid { 
            display: grid; 
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        
        /* Table Styles */
        .attendance-table { font-size: 0.8rem; }
        .attendance-table th { position: sticky; top: 0; z-index: 10; background: #1F4E78; }
        .attendance-table td { min-width: 45px; max-width: 45px; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Menu Sidebar */
        .sidebar { 
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 2px 0 20px rgba(0,0,0,0.1);
        }
        .sidebar.closed { transform: translateX(-100%); }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Gradientes personalizados */
        .gradient-blue { background: linear-gradient(135deg, #1F4E78 0%, #2563eb 100%); }
        .gradient-purple { background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); }
        .gradient-green { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .gradient-orange { background: linear-gradient(135deg, #ea580c 0%, #f59e0b 100%); }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // ============================================
        // CONFIGURAÇÃO
        // ============================================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxsPpM6t_jb1dfguFEhmXe-15FrF7M6NxNzbn5kBmill0OK-bpmsN8SRhjmlKL10fk2VQ/exec';
        const HORAS_EXTRAS_URL = 'https://grupogps-mecanizada.github.io/CLASSIFICAR-HORAS/';
        
        // ============================================
        // CÓDIGOS DE STATUS
        // ============================================
        const STATUS_CODES = {
            'P': { label: 'Presente', color: 'green', icon: 'check-circle', bg: '#dcfce7', text: '#166534' },
            'F': { label: 'Falta', color: 'red', icon: 'x-circle', bg: '#fee2e2', text: '#991b1b' },
            'FE': { label: 'Férias', color: 'yellow', icon: 'sun', bg: '#fef3c7', text: '#92400e' },
            'TR': { label: 'Treinamento', color: 'blue', icon: 'student', bg: '#dbeafe', text: '#1e40af' },
            'AF': { label: 'Afastado', color: 'gray', icon: 'warning', bg: '#e5e7eb', text: '#374151' },
            'AT': { label: 'Atestado', color: 'orange', icon: 'first-aid', bg: '#fed7aa', text: '#9a3412' },
            'FO': { label: 'Folga', color: 'purple', icon: 'coffee', bg: '#f3e8ff', text: '#6b21a8' },
            'EX': { label: 'Extra', color: 'teal', icon: 'star', bg: '#ccfbf1', text: '#115e59' }
        };

        // Níveis de acesso
        const ACCESS_LEVELS = {
            SUPERVISOR: 'supervisor',
            GESTAO: 'gestao'
        };

        // ============================================
        // ESTADO DA APLICAÇÃO
        // ============================================
        let state = {
            view: 'login',
            supervisor: null,
            employees: [],
            selectedDate: getCurrentDate(),
            attendanceRecords: {},
            isLoading: false,
            statistics: null,
            dashboardData: null,
            sidebarOpen: false,
            filters: {
                supervisor: 'all',
                startDate: getMonthStart(),
                endDate: getCurrentDate(),
                status: 'all'
            },
            charts: {}
        };

        // ============================================
        // UTILITÁRIOS
        // ============================================
        function getCurrentDate() {
            return new Date().toISOString().split('T')[0];
        }

        function getMonthStart() {
            const date = new Date();
            return new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('pt-BR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function formatDateShort(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        function getColorClass(color, type = 'bg') {
            const colors = {
                green: type === 'bg' ? 'bg-green-100 border-green-500 text-green-800' : 'bg-green-600',
                red: type === 'bg' ? 'bg-red-100 border-red-500 text-red-800' : 'bg-red-600',
                yellow: type === 'bg' ? 'bg-yellow-100 border-yellow-500 text-yellow-800' : 'bg-yellow-600',
                blue: type === 'bg' ? 'bg-blue-100 border-blue-500 text-blue-800' : 'bg-blue-600',
                gray: type === 'bg' ? 'bg-gray-100 border-gray-500 text-gray-800' : 'bg-gray-600',
                orange: type === 'bg' ? 'bg-orange-100 border-orange-500 text-orange-800' : 'bg-orange-600',
                purple: type === 'bg' ? 'bg-purple-100 border-purple-500 text-purple-800' : 'bg-purple-600',
                teal: type === 'bg' ? 'bg-teal-100 border-teal-500 text-teal-800' : 'bg-teal-600'
            };
            return colors[color] || colors.gray;
        }

        function hasGestaoAccess() {
            return state.supervisor && state.supervisor.accessLevel === ACCESS_LEVELS.GESTAO;
        }

        // ============================================
        // SERVIÇOS / API
        // ============================================
        async function login(username, password) {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro no login:', error);
                return { success: false, error: error.message };
            }
        }

        async function getEmployees(supervisor) {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getEmployees&supervisor=${encodeURIComponent(supervisor)}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro ao buscar colaboradores:', error);
                return { success: false, error: error.message };
            }
        }

        async function getTodayAttendance(supervisor, date) {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAttendance&supervisor=${encodeURIComponent(supervisor)}&date=${date}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro ao buscar presença:', error);
                return { success: false, error: error.message };
            }
        }

        async function saveMultipleAttendance(records) {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'saveMultipleAttendance', records: records })
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro ao salvar presenças:', error);
                return { success: false, error: error.message };
            }
        }

        async function getStatistics(supervisor, startDate, endDate) {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getStatistics&supervisor=${encodeURIComponent(supervisor)}&startDate=${startDate}&endDate=${endDate}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro ao buscar estatísticas:', error);
                return { success: false, error: error.message };
            }
        }

        async function getDashboardData(startDate, endDate, supervisor = 'all') {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getDashboard&startDate=${startDate}&endDate=${endDate}&supervisor=${encodeURIComponent(supervisor)}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro ao buscar dados do dashboard:', error);
                return { success: false, error: error.message };
            }
        }

        async function getAllSupervisors() {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getSupervisors`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro ao buscar supervisores:', error);
                return { success: false, error: error.message };
            }
        }

        // ============================================
        // LÓGICA DE NEGÓCIO
        // ============================================
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('Preencha todos os campos');
                return;
            }

            state.isLoading = true;
            render();

            const result = await login(username, password);

            if (result.success) {
                state.supervisor = result.supervisor;
                localStorage.setItem('supervisor', JSON.stringify(result.supervisor));
                
                // Se for gestão, vai pro dashboard, senão vai pra marcação
                if (hasGestaoAccess()) {
                    await loadDashboard();
                    state.view = 'dashboard';
                } else {
                    await loadEmployees();
                    await loadTodayAttendance();
                    state.view = 'attendance';
                }
            } else {
                alert('Login falhou: ' + (result.error || 'Credenciais inválidas'));
            }

            state.isLoading = false;
            render();
        }

        async function loadEmployees() {
            const result = await getEmployees(state.supervisor.nome);
            if (result.success) {
                state.employees = result.employees;
            }
        }

        async function loadTodayAttendance() {
            const result = await getTodayAttendance(state.supervisor.nome, state.selectedDate);
            if (result.success) {
                state.attendanceRecords = {};
                result.records.forEach(record => {
                    state.attendanceRecords[record.employeeId] = record.status;
                });
            }
        }

        function setAttendance(employeeId, status) {
            state.attendanceRecords[employeeId] = status;
            render();
        }

        async function saveAllAttendance() {
            const records = [];
            
            for (const employeeId in state.attendanceRecords) {
                const employee = state.employees.find(e => e.id === employeeId);
                if (employee) {
                    records.push({
                        date: state.selectedDate,
                        employeeId: employee.id,
                        employeeName: employee.nome,
                        function: employee.funcao,
                        regime: employee.regime,
                        supervisor: state.supervisor.nome,
                        status: state.attendanceRecords[employeeId],
                        observations: ''
                    });
                }
            }

            if (records.length === 0) {
                alert('Nenhuma presença registrada');
                return;
            }

            state.isLoading = true;
            render();

            const result = await saveMultipleAttendance(records);

            if (result.success) {
                alert(`✅ ${records.length} registros salvos com sucesso!`);
            } else {
                alert('Erro ao salvar: ' + result.error);
            }

            state.isLoading = false;
            render();
        }

        function handleLogout() {
            localStorage.removeItem('supervisor');
            state.supervisor = null;
            state.employees = [];
            state.attendanceRecords = {};
            state.dashboardData = null;
            state.view = 'login';
            destroyAllCharts();
            render();
        }

        async function changeDate(newDate) {
            state.selectedDate = newDate;
            await loadTodayAttendance();
            render();
        }

        async function loadStatisticsView() {
            state.view = 'statistics';
            state.isLoading = true;
            render();

            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

            const result = await getStatistics(state.supervisor.nome, startDate, endDate);
            
            if (result.success) {
                state.statistics = result.statistics;
            }

            state.isLoading = false;
            render();
        }

        async function loadDashboard() {
            state.isLoading = true;
            render();

            const result = await getDashboardData(
                state.filters.startDate, 
                state.filters.endDate,
                state.filters.supervisor
            );
            
            if (result.success) {
                state.dashboardData = result.data;
            }

            state.isLoading = false;
            render();
            
            // Renderiza os gráficos após o DOM estar pronto
            setTimeout(() => {
                renderCharts();
            }, 100);
        }

        function toggleSidebar() {
            state.sidebarOpen = !state.sidebarOpen;
            render();
        }

        async function navigateTo(view) {
            state.sidebarOpen = false;
            
            if (view === 'dashboard' && hasGestaoAccess()) {
                await loadDashboard();
            } else if (view === 'attendance') {
                if (!state.employees.length) await loadEmployees();
                await loadTodayAttendance();
            } else if (view === 'statistics') {
                await loadStatisticsView();
                return;
            } else if (view === 'horas-extras') {
                window.open(HORAS_EXTRAS_URL, '_blank');
                return;
            }
            
            state.view = view;
            render();
        }

        async function applyFilters() {
            await loadDashboard();
        }

        function updateFilter(key, value) {
            state.filters[key] = value;
        }

        // ============================================
        // GRÁFICOS
        // ============================================
        function destroyAllCharts() {
            Object.values(state.charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            state.charts = {};
        }

        function renderCharts() {
            if (!state.dashboardData) return;
            
            destroyAllCharts();

            // Gráfico de Atestados por Colaborador
            const atestadosCanvas = document.getElementById('chartAtestados');
            if (atestadosCanvas && state.dashboardData.topAtestados) {
                const ctx = atestadosCanvas.getContext('2d');
                state.charts.atestados = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: state.dashboardData.topAtestados.map(item => item.name.split(' ').slice(0, 2).join(' ')),
                        datasets: [{
                            label: 'Atestados',
                            data: state.dashboardData.topAtestados.map(item => item.count),
                            backgroundColor: 'rgba(234, 88, 12, 0.8)',
                            borderColor: 'rgba(234, 88, 12, 1)',
                            borderWidth: 2,
                            borderRadius: 8,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'Top 10 - Colaboradores com Mais Atestados',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }

            // Gráfico de Faltas por Colaborador
            const faltasCanvas = document.getElementById('chartFaltas');
            if (faltasCanvas && state.dashboardData.topFaltas) {
                const ctx = faltasCanvas.getContext('2d');
                state.charts.faltas = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: state.dashboardData.topFaltas.map(item => item.name.split(' ').slice(0, 2).join(' ')),
                        datasets: [{
                            label: 'Faltas',
                            data: state.dashboardData.topFaltas.map(item => item.count),
                            backgroundColor: 'rgba(220, 38, 38, 0.8)',
                            borderColor: 'rgba(220, 38, 38, 1)',
                            borderWidth: 2,
                            borderRadius: 8,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'Top 10 - Colaboradores com Mais Faltas',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }

            // Gráfico de Distribuição de Status (Pizza)
            const statusCanvas = document.getElementById('chartStatus');
            if (statusCanvas && state.dashboardData.statusTotals) {
                const ctx = statusCanvas.getContext('2d');
                const statusData = Object.entries(state.dashboardData.statusTotals)
                    .filter(([_, count]) => count > 0)
                    .sort((a, b) => b[1] - a[1]);
                
                state.charts.status = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: statusData.map(([code]) => STATUS_CODES[code]?.label || code),
                        datasets: [{
                            data: statusData.map(([_, count]) => count),
                            backgroundColor: statusData.map(([code]) => STATUS_CODES[code]?.bg || '#e5e7eb'),
                            borderColor: statusData.map(([code]) => STATUS_CODES[code]?.text || '#374151'),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { font: { size: 11 }, padding: 10 }
                            },
                            title: {
                                display: true,
                                text: 'Distribuição de Status no Período',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                });
            }

            // Gráfico de Evolução de Presença (Linha)
            const evolucaoCanvas = document.getElementById('chartEvolucao');
            if (evolucaoCanvas && state.dashboardData.dailyStats) {
                const ctx = evolucaoCanvas.getContext('2d');
                const dailyData = state.dashboardData.dailyStats;
                
                state.charts.evolucao = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dailyData.map(item => formatDateShort(item.date)),
                        datasets: [
                            {
                                label: 'Presentes',
                                data: dailyData.map(item => item.P || 0),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Faltas',
                                data: dailyData.map(item => item.F || 0),
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Atestados',
                                data: dailyData.map(item => item.AT || 0),
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { font: { size: 11 }, padding: 10 }
                            },
                            title: {
                                display: true,
                                text: 'Evolução Diária de Registros',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }
        }

        // ============================================
        // RENDERIZAÇÃO
        // ============================================
        function render() {
            const app = document.getElementById('app');
            
            switch(state.view) {
                case 'login':
                    app.innerHTML = renderLogin();
                    break;
                case 'attendance':
                    app.innerHTML = renderAttendance();
                    break;
                case 'statistics':
                    app.innerHTML = renderStatistics();
                    break;
                case 'dashboard':
                    app.innerHTML = renderDashboard();
                    break;
            }
        }

        function renderLogin() {
            return `
                <div class="min-h-screen flex flex-col justify-center items-center p-6" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);">
                    <div class="bg-white p-10 rounded-3xl w-full max-w-md shadow-2xl fade-in relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 gradient-blue"></div>
                        
                        <div class="flex justify-center mb-6">
                            <div class="w-20 h-20 rounded-full gradient-blue flex items-center justify-center shadow-lg">
                                <i class="ph-fill ph-identification-card text-5xl text-white"></i>
                            </div>
                        </div>
                        
                        <h1 class="text-3xl font-black text-center text-gray-900 mb-2">Controle de Presença</h1>
                        <p class="text-center text-gray-500 mb-10 text-sm font-medium">Sistema Integrado de Gestão</p>
                        
                        <form onsubmit="handleLogin(event)" class="space-y-6">
                            <div>
                                <label class="text-xs font-bold text-gray-700 block mb-2 uppercase tracking-wide">Usuário</label>
                                <div class="relative">
                                    <i class="ph ph-user absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl"></i>
                                    <input 
                                        type="text" 
                                        id="username"
                                        class="w-full border-2 border-gray-200 rounded-xl pl-12 pr-4 py-4 focus:border-blue-600 outline-none text-base transition-all"
                                        placeholder="Digite seu nome"
                                        ${state.isLoading ? 'disabled' : ''}
                                        required
                                    >
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-gray-700 block mb-2 uppercase tracking-wide">Senha</label>
                                <div class="relative">
                                    <i class="ph ph-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl"></i>
                                    <input 
                                        type="password" 
                                        id="password"
                                        class="w-full border-2 border-gray-200 rounded-xl pl-12 pr-4 py-4 focus:border-blue-600 outline-none text-base transition-all"
                                        placeholder="Digite sua senha"
                                        ${state.isLoading ? 'disabled' : ''}
                                        required
                                    >
                                </div>
                            </div>
                            
                            <button 
                                type="submit" 
                                class="w-full gradient-blue text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3 text-base ${state.isLoading ? 'opacity-70' : 'hover:scale-[1.02]'}"
                                ${state.isLoading ? 'disabled' : ''}
                            >
                                ${state.isLoading 
                                    ? '<i class="ph ph-spinner animate-spin text-2xl"></i> <span>ENTRANDO...</span>' 
                                    : '<i class="ph ph-sign-in text-xl"></i> <span>ENTRAR NO SISTEMA</span>'
                                }
                            </button>
                        </form>
                        
                        <div class="mt-8 text-center text-xs text-gray-400">
                            <p class="font-medium">Sistema v2.0 | © 2026 GPS Mecanizada</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSidebar() {
            const menuItems = [
                ...(hasGestaoAccess() ? [{
                    icon: 'chart-line-up',
                    label: 'Dashboard',
                    view: 'dashboard',
                    gradient: 'gradient-purple'
                }] : []),
                {
                    icon: 'clipboard-text',
                    label: 'Marcar Presença',
                    view: 'attendance',
                    gradient: 'gradient-blue'
                },
                {
                    icon: 'chart-bar',
                    label: 'Estatísticas',
                    view: 'statistics',
                    gradient: 'gradient-green'
                },
                {
                    icon: 'clock',
                    label: 'Horas Extras',
                    view: 'horas-extras',
                    gradient: 'gradient-orange'
                }
            ];

            return `
                <!-- Overlay -->
                <div class="${state.sidebarOpen ? 'fixed' : 'hidden'} inset-0 bg-black bg-opacity-50 z-40" onclick="toggleSidebar()"></div>
                
                <!-- Sidebar -->
                <aside class="sidebar ${state.sidebarOpen ? '' : 'closed'} fixed left-0 top-0 h-full w-72 bg-white z-50">
                    <div class="p-6 gradient-blue text-white">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                                    <i class="ph-fill ph-user text-2xl"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-sm">${state.supervisor.nome}</h3>
                                    <p class="text-xs opacity-80">${hasGestaoAccess() ? 'Gestão' : 'Supervisor'}</p>
                                </div>
                            </div>
                            <button onclick="toggleSidebar()" class="p-2 hover:bg-white/20 rounded-lg transition-all">
                                <i class="ph ph-x text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <nav class="p-4">
                        ${menuItems.map(item => `
                            <button 
                                onclick="navigateTo('${item.view}')"
                                class="w-full flex items-center gap-4 p-4 rounded-xl mb-2 transition-all hover:bg-gray-50 ${state.view === item.view ? 'bg-gray-100' : ''}"
                            >
                                <div class="w-10 h-10 rounded-lg ${item.gradient} flex items-center justify-center shadow-md">
                                    <i class="ph-fill ph-${item.icon} text-white text-xl"></i>
                                </div>
                                <span class="font-semibold text-gray-700">${item.label}</span>
                            </button>
                        `).join('')}
                        
                        <div class="border-t border-gray-200 my-4"></div>
                        
                        <button 
                            onclick="handleLogout()"
                            class="w-full flex items-center gap-4 p-4 rounded-xl transition-all hover:bg-red-50 text-red-600"
                        >
                            <div class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center">
                                <i class="ph ph-sign-out text-xl"></i>
                            </div>
                            <span class="font-semibold">Sair do Sistema</span>
                        </button>
                    </nav>
                </aside>
            `;
        }

        function renderAttendance() {
            const totalMarked = Object.keys(state.attendanceRecords).length;
            const totalEmployees = state.employees.length;
            const progress = totalEmployees > 0 ? Math.round((totalMarked / totalEmployees) * 100) : 0;

            return `
                ${renderSidebar()}
                
                <div class="min-h-screen bg-gray-50 pb-24">
                    <!-- Header -->
                    <header class="gradient-blue text-white p-4 sticky top-0 z-30 shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-3">
                                <button onclick="toggleSidebar()" class="p-2 rounded-full hover:bg-white/20 transition-all">
                                    <i class="ph ph-list text-2xl"></i>
                                </button>
                                <div>
                                    <h1 class="font-black text-xl">Marcação de Presença</h1>
                                    <p class="text-sm opacity-90 font-medium">${state.supervisor.nome}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Data Selector -->
                        <div class="bg-white/10 rounded-xl p-4 backdrop-blur-sm border border-white/20">
                            <div class="flex items-center justify-between">
                                <button onclick="changeDate('${getPreviousDay(state.selectedDate)}')" class="p-2 hover:bg-white/20 rounded-lg transition-all">
                                    <i class="ph-bold ph-caret-left text-xl"></i>
                                </button>
                                <div class="flex-1 text-center">
                                    <input 
                                        type="date" 
                                        value="${state.selectedDate}"
                                        onchange="changeDate(this.value)"
                                        class="bg-transparent text-white text-center font-bold outline-none cursor-pointer text-lg"
                                    >
                                    <p class="text-xs opacity-90 mt-1 font-medium">${formatDate(state.selectedDate)}</p>
                                </div>
                                <button onclick="changeDate('${getNextDay(state.selectedDate)}')" class="p-2 hover:bg-white/20 rounded-lg transition-all">
                                    <i class="ph-bold ph-caret-right text-xl"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="mt-4">
                            <div class="flex justify-between text-xs mb-2 font-semibold">
                                <span>Progresso: ${totalMarked}/${totalEmployees}</span>
                                <span>${progress}%</span>
                            </div>
                            <div class="w-full bg-white/20 rounded-full h-3 overflow-hidden">
                                <div class="bg-gradient-to-r from-green-400 to-green-500 h-3 rounded-full transition-all duration-500 shadow-lg" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </header>

                    <!-- Employees List -->
                    <main class="p-4 space-y-4 max-w-3xl mx-auto">
                        ${state.employees.length === 0 ? renderNoEmployees() : ''}
                        ${state.employees.map(emp => renderEmployeeCard(emp)).join('')}
                    </main>

                    <!-- Fixed Bottom Bar -->
                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-gray-200 p-4 shadow-2xl">
                        <button 
                            onclick="saveAllAttendance()"
                            ${state.isLoading || totalMarked === 0 ? 'disabled' : ''}
                            class="w-full max-w-3xl mx-auto block gradient-green text-white font-black py-5 rounded-2xl shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed hover:shadow-xl transition-all flex items-center justify-center gap-3 text-lg ${totalMarked > 0 && !state.isLoading ? 'hover:scale-[1.02]' : ''}"
                        >
                            ${state.isLoading 
                                ? '<i class="ph ph-spinner animate-spin text-2xl"></i> <span>SALVANDO...</span>' 
                                : `<i class="ph-fill ph-floppy-disk text-2xl"></i> <span>SALVAR ${totalMarked} REGISTROS</span>`
                            }
                        </button>
                    </div>
                </div>
            `;
        }

        function renderNoEmployees() {
            return `
                <div class="text-center py-16 bg-white rounded-2xl shadow-sm fade-in">
                    <div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                        <i class="ph ph-users-three text-5xl text-gray-300"></i>
                    </div>
                    <p class="text-gray-500 font-medium">Nenhum colaborador encontrado</p>
                </div>
            `;
        }

        function renderEmployeeCard(employee) {
            const currentStatus = state.attendanceRecords[employee.id];
            
            return `
                <div class="bg-white rounded-2xl shadow-md overflow-hidden border-2 ${currentStatus ? 'border-green-500 shadow-lg' : 'border-gray-200'} fade-in transition-all hover:shadow-xl">
                    <div class="p-5">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h3 class="font-black text-lg text-gray-900 leading-tight mb-2">${employee.nome}</h3>
                                <div class="flex gap-2 flex-wrap">
                                    <span class="text-xs px-3 py-1.5 bg-blue-100 text-blue-800 rounded-full font-bold">${employee.funcao}</span>
                                    <span class="text-xs px-3 py-1.5 bg-purple-100 text-purple-800 rounded-full font-bold">${employee.regime}</span>
                                </div>
                            </div>
                            ${currentStatus ? `
                                <div class="text-right ml-3">
                                    <div class="w-12 h-12 rounded-xl shadow-md flex items-center justify-center" style="background: ${STATUS_CODES[currentStatus].bg}">
                                        <i class="ph-fill ph-${STATUS_CODES[currentStatus].icon} text-2xl" style="color: ${STATUS_CODES[currentStatus].text}"></i>
                                    </div>
                                    <p class="text-[10px] font-black mt-1.5 leading-tight" style="color: ${STATUS_CODES[currentStatus].text}">${STATUS_CODES[currentStatus].label}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Status Options Grid -->
                        <div class="grid grid-cols-4 gap-2">
                            ${Object.entries(STATUS_CODES).map(([code, info]) => `
                                <button 
                                    onclick="setAttendance('${employee.id}', '${code}')"
                                    class="status-btn py-3 px-1 rounded-xl border-2 transition-all ${
                                        currentStatus === code 
                                            ? 'scale-105 shadow-lg active border-transparent' 
                                            : 'border-gray-200 hover:border-gray-300 bg-white hover:shadow-md'
                                    }"
                                    style="${currentStatus === code ? `background: ${info.bg}; border-color: ${info.text}` : ''}"
                                >
                                    <i class="ph-fill ph-${info.icon} text-2xl ${currentStatus === code ? '' : 'text-gray-400'}" style="${currentStatus === code ? `color: ${info.text}` : ''}"></i>
                                    <p class="text-[10px] font-black mt-1 leading-tight ${currentStatus === code ? '' : 'text-gray-500'}" style="${currentStatus === code ? `color: ${info.text}` : ''}">${info.label}</p>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStatistics() {
            if (!state.statistics) {
                return `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center">
                        <i class="ph ph-spinner animate-spin text-6xl text-blue-600"></i>
                    </div>
                `;
            }

            const total = Object.values(state.statistics).reduce((a, b) => a + b, 0);

            return `
                ${renderSidebar()}
                
                <div class="min-h-screen bg-gray-50 pb-6">
                    <!-- Header -->
                    <header class="gradient-green text-white p-4 sticky top-0 z-30 shadow-xl">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleSidebar()" class="p-2 rounded-full hover:bg-white/20">
                                <i class="ph ph-list text-2xl"></i>
                            </button>
                            <div>
                                <h1 class="font-black text-xl">Estatísticas</h1>
                                <p class="text-sm opacity-90 font-medium">Resumo do Mês</p>
                            </div>
                        </div>
                    </header>

                    <!-- Statistics Cards -->
                    <main class="p-4 max-w-3xl mx-auto space-y-4">
                        <div class="bg-white rounded-2xl shadow-lg p-8 text-center border-2 border-blue-200 fade-in">
                            <div class="w-16 h-16 rounded-2xl gradient-blue flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <i class="ph-fill ph-calendar-check text-4xl text-white"></i>
                            </div>
                            <h2 class="text-5xl font-black text-gray-900 mb-2">${total}</h2>
                            <p class="text-sm text-gray-600 font-bold uppercase tracking-wider">Total de Registros</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            ${Object.entries(STATUS_CODES).map(([code, info]) => `
                                <div class="bg-white rounded-2xl shadow-md p-6 text-center border-2 transition-all hover:shadow-lg fade-in ${state.statistics[code] > 0 ? 'border-opacity-100' : 'border-gray-200'}" style="${state.statistics[code] > 0 ? `border-color: ${info.text}` : ''}">
                                    <div class="w-14 h-14 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-md" style="background: ${info.bg}">
                                        <i class="ph-fill ph-${info.icon} text-3xl" style="color: ${info.text}"></i>
                                    </div>
                                    <h3 class="text-4xl font-black text-gray-900 mb-1">${state.statistics[code] || 0}</h3>
                                    <p class="text-xs font-bold uppercase tracking-wider text-gray-600">${info.label}</p>
                                </div>
                            `).join('')}
                        </div>
                    </main>
                </div>
            `;
        }

        function renderDashboard() {
            if (!hasGestaoAccess()) {
                return `
                    <div class="min-h-screen bg-gray-50 flex items-center justify-center p-6">
                        <div class="text-center">
                            <i class="ph ph-lock text-6xl text-gray-400 mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-700 mb-2">Acesso Restrito</h2>
                            <p class="text-gray-500">Você não tem permissão para acessar o dashboard completo.</p>
                        </div>
                    </div>
                `;
            }

            return `
                ${renderSidebar()}
                
                <div class="min-h-screen bg-gray-50 pb-6">
                    <!-- Header -->
                    <header class="gradient-purple text-white p-4 sticky top-0 z-30 shadow-xl">
                        <div class="flex items-center gap-4 mb-4">
                            <button onclick="toggleSidebar()" class="p-2 rounded-full hover:bg-white/20">
                                <i class="ph ph-list text-2xl"></i>
                            </button>
                            <div>
                                <h1 class="font-black text-xl">Dashboard Completo</h1>
                                <p class="text-sm opacity-90 font-medium">Visão Geral de Presença</p>
                            </div>
                        </div>
                        
                        <!-- Filtros -->
                        <div class="bg-white/10 rounded-xl p-4 backdrop-blur-sm border border-white/20">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="text-xs font-bold mb-1 block opacity-90">Data Inicial</label>
                                    <input 
                                        type="date" 
                                        value="${state.filters.startDate}"
                                        onchange="updateFilter('startDate', this.value)"
                                        class="w-full bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-sm text-white outline-none focus:bg-white/30"
                                    >
                                </div>
                                <div>
                                    <label class="text-xs font-bold mb-1 block opacity-90">Data Final</label>
                                    <input 
                                        type="date" 
                                        value="${state.filters.endDate}"
                                        onchange="updateFilter('endDate', this.value)"
                                        class="w-full bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-sm text-white outline-none focus:bg-white/30"
                                    >
                                </div>
                                <div class="flex items-end">
                                    <button 
                                        onclick="applyFilters()"
                                        class="w-full bg-white text-purple-700 font-bold py-2 px-4 rounded-lg hover:bg-white/90 transition-all flex items-center justify-center gap-2"
                                    >
                                        <i class="ph-bold ph-funnel text-lg"></i>
                                        <span>Aplicar Filtros</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main class="p-4 max-w-7xl mx-auto">
                        ${state.isLoading ? `
                            <div class="text-center py-16">
                                <i class="ph ph-spinner animate-spin text-6xl text-purple-600 mb-4"></i>
                                <p class="text-gray-600 font-medium">Carregando dados...</p>
                            </div>
                        ` : state.dashboardData ? renderDashboardContent() : ''}
                    </main>
                </div>
            `;
        }

        function renderDashboardContent() {
            const data = state.dashboardData;
            
            return `
                <!-- Cards de Resumo -->
                <div class="dashboard-grid mb-6 fade-in">
                    ${Object.entries(STATUS_CODES).map(([code, info]) => `
                        <div class="bg-white rounded-2xl shadow-md p-6 border-l-4 hover:shadow-lg transition-all" style="border-color: ${info.text}">
                            <div class="flex items-center justify-between mb-3">
                                <div class="w-12 h-12 rounded-xl flex items-center justify-center shadow-md" style="background: ${info.bg}">
                                    <i class="ph-fill ph-${info.icon} text-2xl" style="color: ${info.text}"></i>
                                </div>
                                <span class="text-3xl font-black text-gray-900">${data.statusTotals[code] || 0}</span>
                            </div>
                            <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wide">${info.label}</h3>
                        </div>
                    `).join('')}
                </div>

                <!-- Quadro Completo de Presença -->
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 fade-in">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-black text-gray-900 flex items-center gap-2">
                            <i class="ph-fill ph-table text-purple-600"></i>
                            Quadro Completo de Presença
                        </h2>
                    </div>
                    
                    <div class="overflow-x-auto">
                        ${renderAttendanceTable()}
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Gráfico de Atestados -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
                        <div style="height: 300px;">
                            <canvas id="chartAtestados"></canvas>
                        </div>
                    </div>

                    <!-- Gráfico de Faltas -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
                        <div style="height: 300px;">
                            <canvas id="chartFaltas"></canvas>
                        </div>
                    </div>

                    <!-- Gráfico de Status -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
                        <div style="height: 300px;">
                            <canvas id="chartStatus"></canvas>
                        </div>
                    </div>

                    <!-- Gráfico de Evolução -->
                    <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
                        <div style="height: 300px;">
                            <canvas id="chartEvolucao"></canvas>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAttendanceTable() {
            if (!state.dashboardData || !state.dashboardData.fullGrid) {
                return '<p class="text-gray-500 text-center py-4">Nenhum dado disponível</p>';
            }

            const { employees, dates, records } = state.dashboardData.fullGrid;
            
            return `
                <table class="attendance-table w-full text-left border-collapse">
                    <thead>
                        <tr class="text-white">
                            <th class="sticky left-0 z-20 bg-[#1F4E78] p-3 font-bold text-xs uppercase">Supervisor</th>
                            <th class="p-3 font-bold text-xs uppercase">Regime</th>
                            <th class="p-3 font-bold text-xs uppercase">Colaborador</th>
                            <th class="p-3 font-bold text-xs uppercase">Função</th>
                            ${dates.map(date => `
                                <th class="p-2 text-center font-bold text-xs border-l border-white/20">
                                    ${formatDateShort(date)}
                                </th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody class="text-sm">
                        ${employees.map((emp, idx) => `
                            <tr class="border-b border-gray-200 hover:bg-gray-50 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                <td class="sticky left-0 z-10 p-3 font-semibold text-gray-700 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">${emp.supervisor}</td>
                                <td class="p-3">
                                    <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-bold">${emp.regime}</span>
                                </td>
                                <td class="p-3 font-semibold text-gray-900">${emp.nome}</td>
                                <td class="p-3">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold">${emp.funcao}</span>
                                </td>
                                ${dates.map(date => {
                                    const status = records[emp.id]?.[date];
                                    const statusInfo = status ? STATUS_CODES[status] : null;
                                    return `
                                        <td class="p-1 text-center border-l border-gray-200">
                                            ${statusInfo ? `
                                                <div class="w-10 h-10 rounded-lg mx-auto flex items-center justify-center font-black text-xs shadow-sm" 
                                                     style="background: ${statusInfo.bg}; color: ${statusInfo.text}"
                                                     title="${statusInfo.label}">
                                                    ${status}
                                                </div>
                                            ` : '<div class="w-10 h-10 bg-gray-100 rounded-lg mx-auto"></div>'}
                                        </td>
                                    `;
                                }).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Funções auxiliares de data
        function getPreviousDay(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            date.setDate(date.getDate() - 1);
            return date.toISOString().split('T')[0];
        }

        function getNextDay(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            date.setDate(date.getDate() + 1);
            return date.toISOString().split('T')[0];
        }

        // ============================================
        // INICIALIZAÇÃO
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            const savedSupervisor = localStorage.getItem('supervisor');
            if (savedSupervisor) {
                state.supervisor = JSON.parse(savedSupervisor);
                
                if (hasGestaoAccess()) {
                    loadDashboard().then(() => {
                        state.view = 'dashboard';
                        render();
                    });
                } else {
                    loadEmployees().then(() => {
                        loadTodayAttendance().then(() => {
                            state.view = 'attendance';
                            render();
                        });
                    });
                }
            } else {
                render();
            }
        });
    </script>
</body>
</html>
